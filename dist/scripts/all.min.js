angular.module("servicesModule",["serviceCacheCoreModule"]);
angular.module("servicesModule").factory("httpPaginationData",["$http","$q",function(t,e){function a(t,e,a){if(this.records=[],this.pageState=null,this.pageIndex=-1,this.fetching=!1,this.dataField="data",this.dataMapping=function(t){return t},this.method="get","object"==typeof t&&1===arguments.length){var i=t;this.sourceUrl=i.sourceUrl,this.queryData=i.queryData,this.dataField=i.dataField||this.dataField,this.dataMapping=i.dataMapping||this.dataMapping,this.pageSize=i.pageSize,this.dataGotCallback=i.dataGotCallback}else this.sourceUrl=t,this.queryData=e,this.pageSize=e.pageSize,this.dataGotCallback=a.dataGotCallback;console.log("data got callback = ",this.dataGotCallback),console.log("typeof callback = ",typeof this.dataGotCallback)}function i(a,i){return a.pageIndex<a.records.length-1?((s=a).pageIndex++,e.resolve(s.records[s.pageIndex])):(n=a,r=i,o=angular.extend({},n.queryData,{pageState:n.pageState,pageSize:n.pageSize},r),"get"===n.method&&(o={params:o}),t[n.method](n.sourceUrl,o).then(function(t){return(t=t.data)[n.dataField]&&(n.pageIndex++,n.records.push(n.dataMapping(t[n.dataField]))),t.pageState!==n.pageState?n.pageState=t.pageState:n.pageState=null,t[n.dataField]}));var n,r,o,s}function n(t,e){"function"==typeof t.dataGotCallback&&t.dataGotCallback(e)}return a.prototype.getNextPage=function(t){var e=this;return i(this,t).then(function(t){return n(e,t),t})},a.prototype.getPrevPage=function(){this.pageIndex--,n(this,this.records[this.pageIndex])},a.prototype.getPages=function(){return new Array(this.records.length)},a.prototype.gotoPage=function(t){this.pageIndex=t,n(this,this.records[this.pageIndex])},a}]).factory("paginationData",["service",function(t){function e(t,e){if(this.records=[],this.pageState=null,this.pageIndex=-1,this.fetching=!1,this.dataField="data",this.dataMapping=function(t){return t},"object"==typeof t&&1===arguments.length){var a=t;this.sourceUrl=a.sourceUrl,this.queryData=a.queryData,this.dataField=a.dataField||this.dataField,this.dataMapping=a.dataMapping||this.dataMapping,this.pageSize=a.pageSize}else this.sourceUrl=t,this.queryData=e}return e.prototype.getNextPage=function(e){if(this.pageIndex<this.records.length-1)this.pageIndex++;else{var a=this;t.executePromiseAvoidDuplicate(this,"fetching",function(){return t.post(a.sourceUrl,angular.extend({},a.queryData,{pageState:a.pageState,pageSize:a.pageSize},e)).then(function(t){return t[a.dataField]&&(a.pageIndex++,a.records.push(a.dataMapping(t[a.dataField]))),a.pageState=t.pageState,t})})}},e.prototype.getPrevPage=function(){this.pageIndex--},e.prototype.getPages=function(){return new Array(this.records.length)},e}]).factory("paginationDataWithTotal",["service",function(t){function e(t,e){if(this.records=[],this.pageIndex=-1,this.fetching=!1,this.dataField="data",this.totalField="total",this.dataMapping=function(t){return t},"object"==typeof t&&1===arguments.length){var a=t;this.sourceUrl=a.sourceUrl,this.queryData=a.queryData,this.dataField=a.dataField||this.dataField,this.dataMapping=a.dataMapping||this.dataMapping,this.pageSize=a.pageSize}else this.sourceUrl=t,this.queryData=e}return e.prototype.getNextPage=function(e){if(this.pageIndex<this.records.length-1)this.pageIndex++;else{var a=this;t.executePromiseAvoidDuplicate(this,"fetching",function(){return t.post(a.sourceUrl,angular.extend({},a.queryData,{offset:a.pageSize*(a.pageIndex+1),pageSize:a.pageSize},e)).then(function(t){t[a.dataField]&&(a.pageIndex++,a.records.push(a.dataMapping(t[a.dataField]))),t[a.totalField]&&(a.total=t[a.totalField])})})}},e.prototype.getPrevPage=function(){this.pageIndex--},e.prototype.getPages=function(){return new Array(this.records.length)},e.prototype.getTotalRecords=function(){for(var t=0,e=0;e<this.records.length;e++)t+=this.records[e].length;return t},e}]);
var url={parse:function(e){var r=document.createElement("a");return r.href=e,r}},scripts=document.getElementsByTagName("script"),path=scripts[scripts.length-1].src.split("?")[0],mydir=path.split("/").slice(0,-1).join("/")+"/",scriptLocation=url.parse(mydir);angular.module("servicesModule").factory("service",["api","$q",function(e,r){var t={};for(var n in e)e.hasOwnProperty(n)&&"function"==typeof e[n]&&(t[n]=function(t){return function(){return n=e[t].apply(this,Array.prototype.slice.call(arguments)),o=r.defer(),n.then(function(e){if(!e)return o.reject("未收到服务器数据");(e=e.data).isSuccess?""===e.result||0===e.result||!1===e.result?o.resolve(e.result):o.resolve(e.result||e.results):(console.error(e),console.error(n.value),void 0!==e.code?(o.reject(e),"302"===String(e.code)&&(window.location.href=e.message)):o.reject(e.message||"服务器返回错误的数据"))},function(e){e=e?e.data:"未收到服务器数据",o.reject(e),e&&e.code&&"401"===String(e.code)&&"/sign-in"!==window.location.pathname&&(window.location.href="/sign-in?return_url="+encodeURIComponent(window.location.href))}),o.promise;var n,o}}(n));return t.executePromiseAvoidDuplicate=function(e,t,n){var o=r.defer();return e[t]?(o.reject("submitting..."),o):(e[t]=!0,n().finally(function(){e[t]=!1}))},t.postSync=function(e){var r=new Worker(mydir+"syncRequest.js");r.onmessage=function(e){console.log(e),alert(e.data)},r.postMessage("POST")},t}]);
!function(){var n={},t={},e={};angular.module("serviceCacheCoreModule",[]).factory("cache",["$q",function(n){var t=e;return{get:function(e){var r=t[e];return r?n.resolve(r):n.reject()},set:function(e,r){return t[e]=r,n.resolve()},all:function(){return t}}}]).factory("api",["$http","cache","$q",function(e,r,c){var o={};return["get"].map(function(u){o[u]=function(o,i){return function(o,u,i){var f=o+"$"+u+"$"+(i?JSON.stringify(i):"");if("fetching"===n[f]){console.log("fetching"),t[f]||(t[f]=[]);var a=c.defer();return a.notify("fetching "+f),t[f].push(a),console.log(t),a.promise}return n[f]="fetching",r.get(f).then(function(n){return t[f]&&t[f].map(function(t){t.resolve(n)}),n}).catch(function(n){return e[o](u,i).then(function(n){return r.set(f,n),t[f]&&t[f].map(function(t){t.resolve(n)}),n}).catch(function(n){t[f]&&t[f].map(function(t){t.reject(n)})})}).finally(function(){delete n[f]})}(u,o,i)}}),["post","put","delete"].map(function(n){o[n]=e[n]}),o}])}();
self.onmessage=function(e){if("POST"===e.data){var s=new XMLHttpRequest;s.open("POST","./app.js",!1),s.send(null),self.postMessage(s.responseText)}};